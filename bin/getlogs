#!/bin/bash

CURL_QUITE="-fs"
#set -x

[ -z ${JENKINS_TEST_JOB+x} ] && error "JENKINS_TEST_JOB not set"
SEM_NAME="VGTT_P2952_SEM_ci-auto-test"
IHU_NAME="vcc-ihu_android_ci-auto-test"

function error()
{
  echo "Error: $@" >&2
  exit -1
}

function download_logs()
{
    echo "Downloading logs to $OUTPUT_DIRECTORY..."
    artifacts="$(curl $CURL_QUITE "$ARTIFACTS_URL" 2>&1 | jq | grep relativePath | sed -re 's/.*relativePath.*"(.*)"/\1/')" || error "Could not get artifact output"
    mkdir -p "$OUTPUT_DIRECTORY" || error "Could not create directory $OUTPUT_DIRECTORY"
    pushd $OUTPUT_DIRECTORY &>/dev/null
    for f in $artifacts
    do
        curl $CURL_QUITE -O "${SPECIFIC_JOB_URL}artifact/$f" || { echo "Failed download $f"; sleep 2; }
    done
    popd &>/dev/null
}

[ $# -eq 2 ] || error "Usage: $(basename $0) <s|i> <job number>"
[ "s" = $1 ] && JOB_NAME="$SEM_NAME"
[ "i" = $1 ] && JOB_NAME="$IHU_NAME"
[ -z "$JOB_NAME" ] && error "Did not specify 's' or 'i'"
SPECIFIC_JOB_URL="${JENKINS_TEST_JOB}${JOB_NAME}/${2}/"
ARTIFACTS_URL="${SPECIFIC_JOB_URL}api/json?tree=artifacts[relativePath]"
OUTPUT_DIRECTORY="$HOME/tmp/selinux/${JOB_NAME}_$2"

[ -d $OUTPUT_DIRECTORY ] || download_logs
pushd $OUTPUT_DIRECTORY &>/dev/null
[ 0 -lt $(ls -l *.txt 2>/dev/null| wc -l)  ] || error "Nothing to display in $OUTPUT_DIRECTORY"
cat *.txt | vim -

