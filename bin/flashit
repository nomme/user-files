#!/bin/bash

function error()
{
  echo "Error: $@" >&2
  exit -1
}

[ -z ${AOSP_HOME+x} ] && error "AOSP_HOME not set"
[ -z ${PROJ_DEVICE+x} ] && error "PROJ_DEVICE not set"
[ -z ${PROJ_PRODUCT+x} ] && error "PROJ_PRODUCT not set"

while getopts ad option
do
    case "$option"
        in
        a)
            ABL="--abl"
            ;;
        d)
            DISABLE="--disable-verity --disable-verification"
            ;;
        ?)
            error "Unknown option"
            ;;
    esac
done

shift $((OPTIND-1))

if [ 1 -eq $# ]
then
    FLASH_THIS="$1"
else
    # fast_flashfiles directory missing
    #FLASH_THIS="$AOSP_HOME/out/target/product/$PROJ_DEVICE/fast_flashfiles"
    FLASH_THIS="$AOSP_HOME/out/target/product/$PROJ_DEVICE/$PROJ_PRODUCT-flashfiles-eng.$USER.zip"
fi

function wait_for_fastboot()
{
    echo -n "Waiting for fastboot device..."
    while [ $(fastboot devices | wc -l) -eq 0 ]
    do
        echo -n .
        sleep 1
    done
    echo "Found"
}

function run_fastboot()
{
    echo "Flashing from: $FLASH_THIS"
    [ -f "fastboot.sh" ] || error "No fastboot.sh file found"
    chmod 750 fastboot.sh

    unset ANDROID_SERIAL
    set -x
    ./fastboot.sh $ABL $DISABLE || error "fastboot.sh failed"
    set +x
}

function unpack_zip
{
    TMP_DIR="$(mktemp -d)" || error "Could not create temp directory"
    trap "rm -r $TMP_DIR" EXIT
    unzip -d "$TMP_DIR" "$FLASH_THIS" || error "Could not unzip $FLASH_THIS to $TMP_DIR"
    FLASH_THIS="$TMP_DIR"
}

[ -f "$FLASH_THIS" ] && [ "zip" = ${FLASH_THIS##*.} ] && unpack_zip

[ -d "$FLASH_THIS" ] || error "Flashfiles directory missing: $FLASH_THIS"

pushd $FLASH_THIS > /dev/null

if [ $PROJ_PRODUCT = ihu_kraken ]
then
    [ $(fastboot devices | wc -l) -ne 1 ] && vip pwr bm 2
elif [ $PROJ_PRODUCT = gtt_hydra ]
then
    [ $(fastboot devices | wc -l) -ne 1 ] && { adb reboot bootloader 2>/dev/null || eadb reboot bootloader; }
fi

wait_for_fastboot

run_fastboot

if [ $PROJ_PRODUCT = ihu_kraken ]
then
    vip pwr bm 1
fi

popd > /dev/null

